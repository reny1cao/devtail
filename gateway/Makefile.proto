# Protocol Buffer generation

PROTO_DIR := pkg/protocol/proto
PB_DIR := pkg/protocol/pb
PROTO_FILES := $(wildcard $(PROTO_DIR)/*.proto)

# Install protoc compiler
.PHONY: install-protoc
install-protoc:
	@echo "Installing protoc..."
	@if ! command -v protoc &> /dev/null; then \
		if [ "$$(uname)" = "Darwin" ]; then \
			brew install protobuf; \
		elif [ "$$(uname)" = "Linux" ]; then \
			sudo apt-get update && sudo apt-get install -y protobuf-compiler; \
		else \
			echo "Please install protoc manually"; \
			exit 1; \
		fi \
	fi
	@echo "Installing Go protoc plugins..."
	go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
	go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

# Generate Go code from proto files
.PHONY: proto
proto:
	@echo "Generating Protocol Buffer code..."
	@mkdir -p $(PB_DIR)
	protoc \
		--go_out=$(PB_DIR) \
		--go_opt=paths=source_relative \
		--go-grpc_out=$(PB_DIR) \
		--go-grpc_opt=paths=source_relative \
		-I$(PROTO_DIR) \
		$(PROTO_FILES)

# Clean generated files
.PHONY: clean-proto
clean-proto:
	@echo "Cleaning generated Protocol Buffer files..."
	@rm -rf $(PB_DIR)

# Regenerate proto files
.PHONY: regen-proto
regen-proto: clean-proto proto

# Validate proto files
.PHONY: validate-proto
validate-proto:
	@echo "Validating proto files..."
	@for file in $(PROTO_FILES); do \
		echo "Validating $$file..."; \
		protoc --lint_out=. $$file || true; \
	done